#!/bin/sh

Meta/topics -u |
while read ref upstream; do
	echo $ref ${upstream:-origin}
done |
while read i upstream; do
	case "$i" in
	*/maint-*)
		echo "===> Skipping $i (maint)"
		continue
		;;
	esac

	if test -z "`git rev-list -1 "$upstream" ^$i`"; then
		echo "===> Skipping $i"
		continue
	fi

	echo "===> Rebasing $i"
	git rebase "$upstream" $i || exit 1
done
